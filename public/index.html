<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FÃ¶rderFunke</title>
</head>
<body>
    <h3>User profile</h3>
    <div id="userProfileDiv"></div>
    <h3>Missing data points</h3>
    <label for="focusInput">Set a focus:</label>
    <input type="text" id="focusInput" placeholder="Category or specific benefit">
    <br/><br/>
    <div id="missingDataPointsDiv"></div>
    <h3>Report</h3>
    <table id="reportTable"></table>

    <script src="./bundle.js"></script>
    <script>
        let missingData

        let userProfile = `
@prefix ff: <https://foerderfunke.org/default#> .

ff:mainPerson a ff:Citizen .
        `

        let shacl = `
@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix ff: <https://foerderfunke.org/default#> .

ff:MainPersonShape a sh:NodeShape ;
    sh:targetClass ff:Citizen ;
    sh:property [
        sh:path ff:hasAge ;
        sh:maxExclusive 18 ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
    ] .
        `

        MatchingEngine.validateOne(userProfile, "", "", shacl).then((report) => {
            console.log(report)
        })

        async function fetchTextFile(relPath) {
            const response = await fetch(relPath)
            return await response.text()
        }

        async function loadFiles() {
            let turtleMap = {
                "datafields": await fetchTextFile("requirement-profiles/datafields.ttl"),
                "materialization": await fetchTextFile("requirement-profiles/materialization.ttl"),
                "shacl": {}
            }
            let shaclFiles = await fetchTextFile("shacl-files.txt")
            for (let filename of shaclFiles.split("\n")) {
                if (!filename) continue
                turtleMap.shacl[filename] = await fetchTextFile("requirement-profiles/shacl/" + filename)
            }
            return turtleMap
        }

        async function extractReqProfileNames() {
            let turtleMap = await loadFiles()
            let store = await MatchingEngine.rdfStringsToStore(Object.values(turtleMap.shacl))
            let query = `
PREFIX ff: <https://foerderfunke.org/default#>
SELECT * WHERE {
    ff:metadata ff:title ?title .
}
            `
            let result = await MatchingEngine.runSparqlSelectQueryOnStore(query, store)
            console.log("Req profile titles", result)
        }

        extractReqProfileNames()

        async function validateAll() {
            document.getElementById("userProfileDiv").textContent = userProfile

            let turtleMap = await loadFiles()
            let validateAllReport = await MatchingEngine.validateAll(userProfile, turtleMap.shacl, turtleMap.datafields, turtleMap.materialization)
            console.log(validateAllReport)

            for (let report of validateAllReport.reports) {
                let tr = document.createElement("tr")
                let td = document.createElement("td")
                td.textContent = report.title ? report.title : report.filename
                tr.appendChild(td)
                td = document.createElement("td")
                td.textContent = report.result
                tr.appendChild(td)
                document.getElementById("reportTable").appendChild(tr)
            }

            missingData = validateAllReport.missingUserInputsAggregated
            buildPrioritizedMissingDataList()
        }

        function buildPrioritizedMissingDataList() {
            let div = document.getElementById("missingDataPointsDiv")
            div.textContent = ""
            let prioritizedList = []
            for (let key of Object.keys(missingData)) {
                prioritizedList.push([missingData[key].predicate.split("#")[1], missingData[key].usedIn.length])
            }
            prioritizedList.sort((a, b) => b[1] - a[1])
            prioritizedList.forEach((entry) => {
                let textNode = document.createTextNode(entry[1] + ": ")
                div.appendChild(textNode)
                let a = document.createElement("a")
                a.href = "#"
                a.textContent = entry[0]
                a.addEventListener("click", function(event) {
                    event.preventDefault()
                    let input = prompt("What is your value for " + entry[0])
                    if (input !== null) {
                        console.log(entry[0], "-->", input)
                        // TODO
                    }
                });
                div.appendChild(a)
                div.appendChild(document.createElement("br"))
            });
        }

        validateAll()

    </script>
</body>
</html>
