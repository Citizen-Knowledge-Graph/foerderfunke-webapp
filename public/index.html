<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FÃ¶rderFunke</title>
    <script src="./bundle.js"></script>
    <link rel="stylesheet" href="./choices.min.css" />
    <script src="./choices.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .loadingDiv {
            color: gray;
        }
    </style>
</head>
<body>
    <h3>User profile</h3>
    <div id="userProfileDiv"></div>
    <h3>Missing data points</h3>
    <div>Set a focus:</div>
    <br/>
    <select id="focusInputSelectElement" multiple></select>
    <div class="loadingDiv">Loading...</div>
    <div id="missingDataPointsDiv"></div>
    <h3>Report</h3>
    <div class="loadingDiv">Loading...</div>
    <table id="reportTable"></table>

    <script>
        const element = document.getElementById("focusInputSelectElement")
        const focusInputSelect = new Choices(element, {
            removeItemButton: true,
            position: "bottom",
            placeholderValue: "No focus set --> prioritization of missing data points goes over all requirement profiles",
        });

        let userProfile
        let turtleMap
        let metadata
        let validateAllReport

        async function fetchTextFile(relPath) {
            const response = await fetch(relPath)
            return await response.text()
        }

        async function loadFiles() {
            let turtleMap = {
                "datafields": await fetchTextFile("requirement-profiles/datafields.ttl"),
                "materialization": await fetchTextFile("requirement-profiles/materialization.ttl"),
                "shacl": {}
            }
            let shaclFiles = await fetchTextFile("shacl-files.txt")
            for (let filename of shaclFiles.split("\n")) {
                if (!filename) continue
                turtleMap.shacl[filename] = await fetchTextFile("requirement-profiles/shacl/" + filename)
            }
            return turtleMap
        }

        async function fetchMetadata() {
            metadata = {
                df: await MatchingEngine.extractDatafieldsMetadata(turtleMap.datafields),
                rp: await MatchingEngine.extractRequirementProfilesMetadata(Object.values(turtleMap.shacl))
            }
            console.log("metadata", metadata)
        }

        function buildFocusInputSelectChoices() {
            // TODO

            focusInputSelect.setChoices([
                {
                    label: "GroupA",
                    choices: [
                        {value: "foo", label: "Foo"},
                        {value: "bar", label: "Bar"},
                    ]
                },
                {
                    label: "GroupB",
                    choices: [
                        {value: "hey", label: "Hey"},
                        {value: "jo", label: "Jo"},
                    ]
                },
            ])
        }

        async function validateAll() {
            let userProfileTurtle = await MatchingEngine.convertUserProfileToTurtle(userProfile)
            console.log("userProfileTurtle", userProfileTurtle)
            validateAllReport = await MatchingEngine.validateAll(userProfileTurtle, turtleMap.shacl, turtleMap.datafields, turtleMap.materialization)
            console.log("validateAllReport", validateAllReport)

            let tableEl = document.getElementById("reportTable")
            tableEl.textContent = ""

            for (let report of validateAllReport.reports) {
                let tr = document.createElement("tr")
                let td = document.createElement("td")
                td.textContent = metadata.rp[report.rpUri]?.title ?? report.rpUri
                tr.appendChild(td)
                td = document.createElement("td")
                td.textContent = report.result
                tr.appendChild(td)
                tableEl.appendChild(tr)
            }

            await buildPrioritizedMissingDataList()
        }

        async function buildPrioritizedMissingDataList() {
            let div = document.getElementById("missingDataPointsDiv")
            div.textContent = ""
            let prioritizedList = []

            let missingData = validateAllReport.missingUserInputsAggregated

            for (let key of Object.keys(missingData)) {
                let datafield = missingData[key]
                let usedInTitles = []
                let lastMissingCounter = 0
                for (let usedInRP of datafield.usedIn) {
                    usedInTitles.push(metadata.rp[usedInRP.rpUri].title + (usedInRP.isLastMissingUserInput ? " (!)" : ""))
                    if (usedInRP.isLastMissingUserInput) lastMissingCounter += 1
                }
                prioritizedList.push({
                    dfUri: datafield.dfUri,
                    label: metadata.df[datafield.dfUri]?.label ?? datafield.dfUri.split("#")[1],
                    score: datafield.usedIn.length + lastMissingCounter,
                    usedInTitles: usedInTitles
                })
            }
            prioritizedList.sort((a, b) => b.score - a.score)
            prioritizedList.forEach((entry) => {
                let spanEl = document.createElement("span")
                spanEl.title = entry.usedInTitles.join("\n")
                spanEl.style.color = "gray"
                let textNode = document.createTextNode(entry.score + ": ")
                spanEl.appendChild(textNode)
                div.appendChild(spanEl)
                let a = document.createElement("a")
                a.href = "#"
                a.textContent = entry.label
                a.addEventListener("click", function(event) {
                    event.preventDefault()
                    let input = prompt("What is your value for: " + entry.label)
                    if (input !== null) {
                        console.log(entry.dfUri, "-->", input)
                        addProfileEntry(entry.dfUri, input)
                    }
                });
                div.appendChild(a)
                div.appendChild(document.createElement("br"))
            });
            for (const elem of Array.from(document.getElementsByClassName("loadingDiv"))) {
                elem.style.display = "none"
            }
        }

        async function addProfileEntry(dfUri, value) {
            let key = "ff:" + dfUri.split("#")[1]
            let result = await MatchingEngine.validateSingleDatafieldValue({ [key]: value }, turtleMap.datafields)
            if (!result.conforms) {
                let msgs = "\n"
                for (let violation of result.violations) {
                    msgs += violation.message + "\n"
                }
                alert(value + " is an invalid input for " + metadata.df[dfUri].label + ": " + msgs)
                return
            }
            userProfile[key] = value
            console.log("userProfile", userProfile)
            localStorage.setItem("userProfile", JSON.stringify(userProfile))
            await buildProfile()
            await validateAll()
        }

        async function buildProfile() {
            let div = document.getElementById("userProfileDiv")
            div.textContent = ""
            let table = document.createElement("table")
            div.appendChild(table)

            for (let [key, value] of Object.entries(userProfile)) {
                if (key.startsWith("ff:")) key = "https://foerderfunke.org/default#" + key.slice(3)
                let tr = document.createElement("tr")
                table.appendChild(tr)
                let td = document.createElement("td")
                td = document.createElement("td")
                td.textContent = metadata.df[key].label + ": "
                td.style.color = "gray"
                td.title = key
                tr.appendChild(td)
                td = document.createElement("td")
                td.textContent = value
                tr.appendChild(td)
            }
        }

        async function run() {
            // localStorage.clear()
            if (localStorage.getItem("userProfile") === null) {
                localStorage.setItem("userProfile", JSON.stringify({}));
            }
            userProfile = JSON.parse(localStorage.getItem("userProfile"))

            turtleMap = await loadFiles()
            await fetchMetadata()
            await buildProfile()
            await validateAll()
            // buildFocusInputSelectChoices()
        }

        run()

    </script>
</body>
</html>
